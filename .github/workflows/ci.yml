name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 45 # è®¾ç½®ä»»åŠ¡è¶…æ—¶ä¸º 45 åˆ†é’Ÿ
    strategy:
      matrix:
        node-version: [22.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'yarn'
        registry-url: 'https://registry.npmjs.org'

    - name: Install Yarn
      run: npm install -g yarn # ç¡®ä¿ Yarn å¯ç”¨

    - name: Install dependencies
      run: |
        yarn config set network-timeout 300000
        yarn install --network-timeout 300000

    - name: Run linting
      run: yarn lint # å‡è®¾ package.json ä¸­ script åä¸º lint

    - name: TypeScript type check
      run: yarn tsc --noEmit # ä½¿ç”¨ Yarn è°ƒç”¨ tsc

    - name: AI Code Review
      run: |
        echo "ğŸ¤– å¼€å§‹AIä»£ç å®¡æŸ¥..."
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p /tmp/code-review
        
        # æ™ºèƒ½è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨
        if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
          # PRåœºæ™¯ï¼šè·å–åˆ†æ”¯é—´çš„å®Œæ•´å·®å¼‚
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          CHANGED_FILES=$(git diff --name-only --diff-filter=AMR $BASE_SHA...$HEAD_SHA)
        else
          # Pushåœºæ™¯ï¼šæ™ºèƒ½åˆ¤æ–­å˜æ›´èŒƒå›´
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            # æ£€æŸ¥æ˜¯å¦åªä¿®æ”¹äº†éä¸šåŠ¡æ–‡ä»¶
            ALL_CHANGED=$(git diff --name-only HEAD~1..HEAD)
            BUSINESS_CHANGED=$(echo "$ALL_CHANGED" | grep -E '^(src/|components/|hooks/|utils/|lib/).*\.(js|ts|jsx|tsx)$' || true)
            
            if [ -z "$BUSINESS_CHANGED" ]; then
              echo "ğŸ“ æœ¬æ¬¡æäº¤æœªä¿®æ”¹ä¸šåŠ¡ä»£ç ï¼Œè·³è¿‡AIå®¡æŸ¥"
              exit 0
            fi
            
            CHANGED_FILES="$BUSINESS_CHANGED"
          else
            # åˆå§‹æäº¤ï¼šä»…å®¡æŸ¥æ ¸å¿ƒå…¥å£æ–‡ä»¶
            CHANGED_FILES=$(git ls-files | grep -E '^src/(main|index|App)\.(js|ts|jsx|tsx)$' | head -3)
          fi
        fi
        
        # æ™ºèƒ½è¿‡æ»¤ï¼šåªåŒ…å«æ ¸å¿ƒä¸šåŠ¡ä»£ç 
        FILTERED_FILES=""
        for file in $CHANGED_FILES; do
          # åŒ…å«è·¯å¾„ï¼šsrc/, components/, hooks/, utils/, lib/
          if echo "$file" | grep -E '^(src/|components/|hooks/|utils/|lib/).*\.(js|ts|jsx|tsx)$' > /dev/null; then
            # æ’é™¤æµ‹è¯•æ–‡ä»¶ã€é…ç½®æ–‡ä»¶
            if ! echo "$file" | grep -E '(\.(test|spec)\.|\.config\.|\.d\.ts$|/__tests__/|/test/)' > /dev/null; then
              # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶500è¡Œä»¥å†…ï¼‰
              if [ -f "$file" ] && [ $(wc -l < "$file" 2>/dev/null || echo 0) -le 500 ]; then
                FILTERED_FILES="$FILTERED_FILES $file"
              fi
            fi
          fi
        done
        
        if [ -z "$FILTERED_FILES" ]; then
          echo "ğŸ“ æ²¡æœ‰å‘ç°éœ€è¦å®¡æŸ¥çš„æ ¸å¿ƒä»£ç æ–‡ä»¶"
          exit 0
        fi
        
        # é™åˆ¶å®¡æŸ¥æ–‡ä»¶æ•°é‡ï¼ˆæœ€å¤š5ä¸ªæ–‡ä»¶ï¼‰
        FILE_COUNT=$(echo $FILTERED_FILES | wc -w)
        if [ $FILE_COUNT -gt 5 ]; then
          FILTERED_FILES=$(echo $FILTERED_FILES | cut -d' ' -f1-5)
          echo "âš ï¸  æ–‡ä»¶æ•°é‡è¿‡å¤šï¼Œä»…å®¡æŸ¥å‰5ä¸ªæ–‡ä»¶"
        fi
        
        echo "ğŸ“‹ å°†å®¡æŸ¥ä»¥ä¸‹ $(echo $FILTERED_FILES | wc -w) ä¸ªæ–‡ä»¶ï¼š"
        echo "$FILTERED_FILES"
        
        # æ‰¹é‡å®¡æŸ¥æ–‡ä»¶
        REVIEW_COUNT=0
        for file in $FILTERED_FILES; do
          if [ -f "$file" ]; then
            echo "ğŸ” æ­£åœ¨å®¡æŸ¥: $file"
            
            # è·å–å®Œæ•´æ–‡ä»¶å†…å®¹å’Œå˜æ›´å·®å¼‚
            FILE_CONTENT=$(cat "$file" 2>/dev/null || echo "æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹")
            
            # æ„é€ å¢å¼ºçš„å®¡æŸ¥è¯·æ±‚
            REQUEST_BODY=$(jq -n \
              --arg file "$file" \
              --arg content "$FILE_CONTENT" \
              '{
                "messages": [{
                  "role": "user", 
                  "content": ("è¯·å®¡æŸ¥ä»¥ä¸‹ä»£ç æ–‡ä»¶ï¼Œé‡ç‚¹å…³æ³¨ä»£ç è´¨é‡ã€å®‰å…¨æ€§ã€æ€§èƒ½å’Œæœ€ä½³å®è·µï¼š\n\næ–‡ä»¶è·¯å¾„: " + $file + "\n\nå®Œæ•´ä»£ç :\n" + $content + "\n\nè¯·æä¾›ç®€æ´çš„å®¡æŸ¥æ„è§ï¼ŒåŒ…æ‹¬:\n1. ä¸»è¦é—®é¢˜ï¼ˆå¦‚æœ‰ï¼‰\n2. æ”¹è¿›å»ºè®®\n3. ä»£ç äº®ç‚¹ï¼ˆå¦‚æœ‰ï¼‰")
                }]
              }')
            
            # è°ƒç”¨APIï¼ˆè®¾ç½®è¶…æ—¶ï¼‰
            RESPONSE=$(timeout 30 curl -s -X POST \
              -H "Content-Type: application/json" \
              -d "$REQUEST_BODY" \
              "https://ai-codereview-agent.liuweiyuan0713.workers.dev/api/agents/codeReviewAgent/generate" \
              2>/dev/null || echo '{"text": "å®¡æŸ¥è¶…æ—¶æˆ–APIè°ƒç”¨å¤±è´¥"}')
            
            # è§£æå’Œä¿å­˜ç»“æœ
            REVIEW_TEXT=$(echo "$RESPONSE" | jq -r '.text // "æ— æ³•è·å–å®¡æŸ¥ç»“æœ"')
            
            {
              echo "## ğŸ“„ $file"
              echo ""
              echo "$REVIEW_TEXT"
              echo ""
              echo "---"
              echo ""
            } >> /tmp/code-review/review-${{ github.run_id }}.md
            
            REVIEW_COUNT=$((REVIEW_COUNT + 1))
            echo "âœ… å®Œæˆå®¡æŸ¥ ($REVIEW_COUNT/$(echo $FILTERED_FILES | wc -w)): $file"
          fi
        done
        
        echo "ğŸ‰ AIä»£ç å®¡æŸ¥å®Œæˆï¼å®¡æŸ¥äº† $REVIEW_COUNT ä¸ªæ–‡ä»¶"
        
        # è¾“å‡ºå®¡æŸ¥æ‘˜è¦
        if [ -f "/tmp/code-review/review-${{ github.run_id }}.md" ]; then
          echo ""
          echo "ğŸ“Š === ä»£ç å®¡æŸ¥æŠ¥å‘Šæ‘˜è¦ ==="
          head -100 /tmp/code-review/review-${{ github.run_id }}.md
        fi

    - name: Run unit tests
      run: yarn test:unit # å‡è®¾ package.json ä¸­ script åä¸º test:unit

    - name: Start development server
      run: |
        yarn client:server &
        sleep 30 # ä¿æŒåŸé€»è¾‘ï¼Œå¯åŠ¨å¼€å‘æœåŠ¡å™¨å¹¶ç­‰å¾…

    - name: Run e2e tests
      run: yarn test:e2e # å‡è®¾ package.json ä¸­ script åä¸º test:e2e


    - name: Upload test coverage
      uses: codecov/codecov-action@v4
      with:
        directory: ./docs/jest-coverage
        fail_ci_if_error: true
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # è®¾ç½®ä»»åŠ¡è¶…æ—¶ä¸º 30 åˆ†é’Ÿ
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'yarn'
        registry-url: 'https://registry.npmjs.org'

    - name: Install Yarn
      run: npm install -g yarn # ç¡®ä¿ Yarn å¯ç”¨

    - name: Install dependencies
      run: |
        yarn config set network-timeout 300000
        yarn install --frozen-lockfile --network-timeout 300000

    - name: Build production
      run: yarn client:prod # å‡è®¾ package.json ä¸­ script åä¸º client:prod

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/

    - name: Configure registry for Wrangler
      run: yarn config set registry https://registry.npmjs.org

    - name: Deploy to Cloudflare Pages
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        command: pages deploy dist --project-name=${{ secrets.CLOUDFLARE_PROJECT_NAME }}