name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 45 # è®¾ç½®ä»»åŠ¡è¶…æ—¶ä¸º 45 åˆ†é’Ÿ
    strategy:
      matrix:
        node-version: [22.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'yarn'
        registry-url: 'https://registry.npmjs.org'

    # æš‚æ—¶æ³¨é‡Šæ‰å…¶ä»–æ­¥éª¤ï¼Œåªæµ‹è¯•AIä»£ç èµ°è¯»
    # - name: Install Yarn
    #   run: npm install -g yarn # ç¡®ä¿ Yarn å¯ç”¨

    # - name: Install dependencies
    #   run: |
    #     yarn config set network-timeout 300000
    #     yarn install --network-timeout 300000

    # - name: Run linting
    #   run: yarn lint # å‡è®¾ package.json ä¸­ script åä¸º lint

    # - name: TypeScript type check
    #   run: yarn tsc --noEmit # ä½¿ç”¨ Yarn è°ƒç”¨ tsc

    - name: AI Code Review
      timeout-minutes: 10  # è®¾ç½®AIä»£ç èµ°è¯»è¶…æ—¶ä¸º5åˆ†é’Ÿ
      run: |
        # è·å–å½“å‰åˆ†æ”¯ä¸mainåˆ†æ”¯çš„å·®å¼‚æ–‡ä»¶
        echo "ğŸ¤– å¼€å§‹AIä»£ç å®¡æŸ¥..."
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜å‚¨å®¡æŸ¥ç»“æœ
        mkdir -p /tmp/code-review
        
        # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
        if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
          # PRäº‹ä»¶ï¼šæ¯”è¾ƒç›®æ ‡åˆ†æ”¯
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          git fetch origin "$BASE_BRANCH"
          CHANGED_FILES=$(git diff --name-only --diff-filter=AMR origin/"$BASE_BRANCH"...HEAD | grep -E '\.(js|ts|jsx|tsx)$' || true)
        else
          # Pushäº‹ä»¶ï¼šæ¯”è¾ƒä¸Šä¸€æ¬¡æäº¤
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only --diff-filter=AMR HEAD~1..HEAD | grep -E '\.(js|ts|jsx|tsx)$' || true)
          else
            # é¦–æ¬¡æäº¤ï¼Œè·å–æ‰€æœ‰æ–‡ä»¶
            CHANGED_FILES=$(git ls-files | grep -E '\.(js|ts|jsx|tsx)$' || true)
          fi
        fi
        
        if [ -z "$CHANGED_FILES" ]; then
          echo "ğŸ“ æ²¡æœ‰å‘ç°éœ€è¦å®¡æŸ¥çš„ä»£ç æ–‡ä»¶"
          exit 0
        fi
        
        echo "ğŸ“‹ å‘ç°ä»¥ä¸‹æ–‡ä»¶éœ€è¦å®¡æŸ¥ï¼š"
        echo "$CHANGED_FILES"
        
        # é€ä¸ªæ–‡ä»¶è¿›è¡Œä»£ç å®¡æŸ¥
        for file in $CHANGED_FILES; do
          if [ -f "$file" ]; then
            echo "ğŸ” æ­£åœ¨å®¡æŸ¥æ–‡ä»¶: $file"
            
            # è·å–æ–‡ä»¶å·®å¼‚å†…å®¹
            if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
              DIFF_CONTENT=$(git diff origin/"$BASE_BRANCH"...HEAD -- "$file" || true)
            else
              if git rev-parse HEAD~1 >/dev/null 2>&1; then
                DIFF_CONTENT=$(git diff HEAD~1..HEAD -- "$file" || true)
              else
                # é¦–æ¬¡æäº¤ï¼Œæ˜¾ç¤ºæ•´ä¸ªæ–‡ä»¶å†…å®¹
                DIFF_CONTENT=$(cat "$file" || true)
              fi
            fi
            
            if [ ! -z "$DIFF_CONTENT" ]; then
              # æ£€æŸ¥æ˜¯å¦åªæ˜¯æ³¨é‡Šå˜æ›´
              COMMENT_ONLY_CHANGE=$(echo "$DIFF_CONTENT" | grep -E '^[+\-]' | grep -v -E '^[+\-].*//.*[^/]' | grep -v -E '^[+\-].*\*.*[^*]' | wc -l | tr -d ' ')
              TOTAL_CHANGES=$(echo "$DIFF_CONTENT" | grep -E '^[+\-]' | wc -l | tr -d ' ')
              
              # è·å–æ–‡ä»¶çš„å®Œæ•´å†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡
              FULL_CONTENT=$(cat "$file" 2>/dev/null || echo "æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹")
              
              # æ ¹æ®å˜æ›´ç±»å‹æ„é€ ä¸åŒçš„å®¡æŸ¥è¯·æ±‚
              if [ "$COMMENT_ONLY_CHANGE" -eq 0 ] && [ "$TOTAL_CHANGES" -le 3 ]; then
                # ä»…æ³¨é‡Šå˜æ›´çš„ç®€åŒ–è¯·æ±‚
                REQUEST_BODY=$(jq -n --arg content "è¯·ç®€è¦å®¡æŸ¥ä»¥ä¸‹æ³¨é‡Šå˜æ›´ï¼š

        ğŸ“ æ–‡ä»¶: $file

        ğŸ”„ å˜æ›´å†…å®¹:
        \`\`\`diff
        $DIFF_CONTENT
        \`\`\`

        è¿™ä¼¼ä¹æ˜¯æ³¨é‡Šç›¸å…³çš„å˜æ›´ï¼Œè¯·ç®€è¦ç¡®è®¤æ³¨é‡Šå†…å®¹æ˜¯å¦åˆé€‚ã€‚" '{"messages": [{"role": "user", "content": $content}]}')
              else
                # å®Œæ•´çš„ä»£ç å®¡æŸ¥è¯·æ±‚
                REQUEST_BODY=$(jq -n --arg content "è¯·å®¡æŸ¥ä»¥ä¸‹ä»£ç å˜æ›´ï¼š

        ğŸ“ æ–‡ä»¶è·¯å¾„: $file

        ğŸ”„ å˜æ›´å†…å®¹ (diff):
        \`\`\`diff
        $DIFF_CONTENT
        \`\`\`

        ğŸ“‹ å®Œæ•´æ–‡ä»¶å†…å®¹ (ç”¨äºä¸Šä¸‹æ–‡å‚è€ƒ):
        \`\`\`typescript
        $FULL_CONTENT
        \`\`\`

        è¯·é‡ç‚¹å…³æ³¨å˜æ›´çš„éƒ¨åˆ†ï¼Œå¹¶ç»“åˆå®Œæ•´ä»£ç ä¸Šä¸‹æ–‡è¿›è¡Œå®¡æŸ¥ã€‚" '{"messages": [{"role": "user", "content": $content}]}')
              fi
              
              # è°ƒç”¨AIä»£ç å®¡æŸ¥API
              RESPONSE=$(curl -s -X POST \
                -H "Content-Type: application/json" \
                -d "$REQUEST_BODY" \
                "https://ai-codereview-agent.liuweiyuan0713.workers.dev/api/agents/codeReviewAgent/generate" \
                2>/dev/null || echo '{"text": "APIè°ƒç”¨å¤±è´¥"}')
              
              # è§£æå“åº”å¹¶ä¿å­˜ç»“æœ
              REVIEW_TEXT=$(echo "$RESPONSE" | jq -r '.text // "æ— æ³•è·å–å®¡æŸ¥ç»“æœ"')
              
              # ä¿å­˜å®¡æŸ¥ç»“æœåˆ°æ–‡ä»¶
              {
                echo "## ğŸ“„ æ–‡ä»¶: $file"
                echo ""
                echo "$REVIEW_TEXT"
                echo ""
                echo "---"
                echo ""
              } >> /tmp/code-review/review-${{ github.run_id }}.md
              
              echo "âœ… å®Œæˆå®¡æŸ¥: $file"
            fi
          fi
        done
        
        echo "ğŸ‰ AIä»£ç å®¡æŸ¥å®Œæˆï¼"
        
        # è¾“å‡ºå®¡æŸ¥ç»“æœæ‘˜è¦
        if [ -f "/tmp/code-review/review-${{ github.run_id }}.md" ]; then
          echo "ğŸ“Š ä»£ç å®¡æŸ¥æŠ¥å‘Šï¼š"
          head -50 /tmp/code-review/review-${{ github.run_id }}.md
        fi

    # æš‚æ—¶æ³¨é‡Šæ‰å…¶ä»–æµ‹è¯•æ­¥éª¤ï¼Œåªæµ‹è¯•AIä»£ç èµ°è¯»
    # - name: Run unit tests
    #   run: yarn test:unit # å‡è®¾ package.json ä¸­ script åä¸º test:unit

    # - name: Start development server
    #   run: |
    #     yarn client:server &
    #     sleep 30 # ä¿æŒåŸé€»è¾‘ï¼Œå¯åŠ¨å¼€å‘æœåŠ¡å™¨å¹¶ç­‰å¾…

    # - name: Run e2e tests
    #   run: yarn test:e2e # å‡è®¾ package.json ä¸­ script åä¸º test:e2e

    # - name: Upload test coverage
    #   uses: codecov/codecov-action@v4
    #   with:
    #     directory: ./docs/jest-coverage
    #     fail_ci_if_error: true
    #   env:
    #     CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # æš‚æ—¶æ³¨é‡Šæ‰buildå’Œdeployï¼Œåªæµ‹è¯•AIä»£ç èµ°è¯»
  # build:
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 30 # è®¾ç½®ä»»åŠ¡è¶…æ—¶ä¸º 30 åˆ†é’Ÿ
  #   needs: test
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4

  #   - name: Use Node.js 20.x
  #     uses: actions/setup-node@v4
  #     with:
  #       node-version: 20.x
  #       cache: 'yarn'
  #       registry-url: 'https://registry.npmjs.org'

  #   - name: Install Yarn
  #     run: npm install -g yarn # ç¡®ä¿ Yarn å¯ç”¨

  #   - name: Install dependencies
  #     run: |
  #       yarn config set network-timeout 300000
  #       yarn install --frozen-lockfile --network-timeout 300000

  #   - name: Build production
  #     run: yarn client:prod # å‡è®¾ package.json ä¸­ script åä¸º client:prod

  #   - name: Upload build artifacts
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: dist
  #       path: dist/

  # deploy:
  #   runs-on: ubuntu-latest
  #   needs: build
  #   if: github.ref == 'refs/heads/main'
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4

  #   - name: Download build artifacts
  #     uses: actions/download-artifact@v4
  #     with:
  #       name: dist
  #       path: dist/

  #   - name: Deploy to Cloudflare Pages
  #     uses: cloudflare/wrangler-action@v3
  #     with:
  #       apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  #       accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  #       command: pages deploy dist --project-name=${{ secrets.CLOUDFLARE_PROJECT_NAME }}